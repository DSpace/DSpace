<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN" "http://www.w3.org/TR/REC-html40/strict.dtd">
<HTML>
  <HEAD>
    <TITLE>DSpace System Documentation: Installation</TITLE>
    <LINK REL=StyleSheet HREF="style.css" TYPE="text/css">
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" >
  </HEAD>
  <BODY>
    <H1>DSpace System Documentation: Installation</H1>

    <P><A HREF="index.html">Back to contents</A></P>


    <H2><A NAME="prerequisite">Prerequisites</A></H2>

    <P>The list below describes the third-party components and tools you'll need to run a DSpace server.  These are simply recommendations based on our setup at MIT; since DSpace is built on open source, standards-based tools, there are numerous other possibilities and setups.</P>

    <P>Also, please note that the configuration and installation guidelines relating to a particular tool below are here for convenience.  You should refer to the documentation for each individual component for complete and up-to-date details.  Many of the tools are updated on a frequent basis, and the guidelines below may become out of date.</P>

    <ol>
      <li><P>UNIX-like OS (Linux, HP/UX etc)</P></li>

      <li><P><A HREF="http://java.sun.com/">Java 1.4</A> or later (standard SDK is fine, you don't need J2EE)</P></li>

      <li><P><A HREF="http://ant.apache.org/">Apache Ant 1.5</A> or later (Java make-like tool)</P></li>

      <li>
        <P><A HREF="http://www.postgresql.org/">PostgreSQL 7.3</A> or later, an open source relational database, or <a href="http://www.oracle.com/database/">Oracle 9 or higher</A>.</P>

        <UL>
          <LI>
            <P><strong>PostgreSQL</strong></P>

            <P>Unicode (specifically UTF-8) support must be enabled.  This is enabled by default in 8.0+.  For 7.<em>x</em>, be sure to compile with the following options to the '<code>configure</code>' script:</P>

            <PRE>--enable-multibyte --enable-unicode --with-java</PRE>

            <P><A NAME="enabletcpip"></a>Once installed, you need to enable TCP/IP connections (DSpace uses JDBC).  For 7.<em>x</em>, edit <code>postgresql.conf</code> (usually in <code>/usr/local/pgsql/data</code> or <code>/var/lib/pgsql/data</code>), and add this line:</P>

            <PRE>tcpip_socket = true</PRE>

            <P>For 8.0+, in <code>postgresql.conf</code> uncomment the line starting:</P>

            <PRE>listen_addresses = 'localhost'</PRE>

            <P>Then tighten up security a bit by editing <code>pg_hba.conf</code> and adding this line:</P>

            <PRE>host  dspace  dspace  127.0.0.1  255.255.255.255  md5</PRE>

            <P>Then restart PostgreSQL.</P>
          </LI>

          <LI>
            <P><strong>Oracle</strong></P>

            <P>Copy the Oracle JDBC driver into <code><i>[dspace-source]</i>/lib</code>.</P>

            <P>Create a database for DSpace.  Make sure that the character set is one of the Unicode character sets.  DSpace uses UTF-8 natively, and it is suggested that the Oracle database use the same character set.  Create a user account for DSpace (e.g. <code>dspace</code>,) and ensure that it has permissions to add and remove tables in the database.</P>

            <P>Edit the config/dspace.cfg file in your source directory for the  following settings:</P>

<PRE>db.name   = oracle
db.url    = jdbc.oracle.thin:@//host:port/dspace
db.driver = oracle.jdbc.OracleDriver</PRE>

            <P>Go to <code><i>[dspace-source]</i>/etc/oracle</code> and copy the contents to their parent directory, overwriting the versions in the parent:

<PRE>cd dspace_source/etc/oracle
cp * ..</PRE>

            <P>You now have Oracle-specific <code>.sql</code> files in your <code>etc</code> directory, and your dspace.cfg is modified to point to your Oracle database and are ready to continue with a normal DSpace install, skipping the Postgres setup steps.</P>

            <P><STRONG>NOTE:</STRONG> DSpace uses sequences to generate unique object IDs - beware Oracle sequences, which are said to lose their values when doing a database export/import, say restoring from a backup.  Be sure to run the script <code>etc/update-sequences.sql</code>.</P>

            <P><STRONG>ALSO NOTE:</STRONG> Everything is fully functional, although Oracle limits you to 4k of text in text fields such as item metadata or collection descriptions.</P>

            <P>For people interested in switching from Postgres to Oracle, I know of no tools that would do this automatically.  You will need to recreate the community, collection, and eperson structure in the Oracle system, and then use the item export and import tools to move your content over.</P>
          </LI>
        </UL>

      </li>

      <li><P><A HREF="http://jakarta.apache.org/tomcat/">Jakarta Tomcat 4.x/5.x</A> or equivalent, such as <A HREF="http://www.mortbay.org/jetty/index.html">Jetty</A> or <A HREF="http://www.caucho.com/">Caucho Resin</A>.</P>

      <P>Note that DSpace will need to run as the same user as Tomcat, so you might want to install and run Tomcat as a user called '<code>dspace</code>'.</P>

      <P>You need to ensure that Tomcat has a) enough memory to run DSpace and b) uses UTF-8 as its default file encoding for international character support.  So ensure in your startup scripts (etc) that the following environment variable is set:</P>

      <PRE>JAVA_OPTS="-Xmx512M -Xms64M -Dfile.encoding=UTF-8"</PRE>

      <P>You also need to alter Tomcat's default configuration to support searching and browsing of multi-byte UTF-8 correctly.  You need to add a configuration option to the <code>&lt;Connector&gt;</code> element in <code><i>[tomcat]</i>/config/server.xml</code>:</P>

      <PRE>URIEncoding="UTF-8"</PRE>

      <P>e.g. if you're using the default Tomcat config, it should read:</P>

      <PRE>&lt;!-- Define a non-SSL HTTP/1.1 Connector on port 8080 --&gt;
&lt;Connector port="8080"
           maxThreads="150" minSpareThreads="25" maxSpareThreads="75"
           enableLookups="false" redirectPort="8443" acceptCount="100"
           connectionTimeout="20000" disableUploadTimeout="true"
           <strong>URIEncoding="UTF-8"</strong> /&gt;</PRE>

       <P>Jetty and Resin are configured for correct handling of UTF-8 by default.</P>
      </li>
    </ol>


    <H2><A NAME="installsteps">Quick Installation Steps</A></H2>

    <p><strong>But First, a Word on Directories and Path Names</strong></p>

    <p>DSpace uses three separate directory trees. Although you don't need to know all the details
of them in order to install DSpace, you do need to know they exist and also know how they're referred to in this document:<p>
    <ul>
    <li>the source directory, referred to as <i><code>[dspace-source]</code></i></li>
    <li>the install directory, referred to as <i><code>[dspace]</code></i></li>
    <li>the web deployment directory. If you're using Tomcat, this will be <code><i>[tomcat]</i>/webapps/dspace</code> (with <code><i>[tomcat]</i></code> being wherever
you installed Tomcat--also known as $CATALINA_HOME). This directory is generated by the web server when it unpacks dspace.war, and should never be edited.</li>
    </ul>

    <p>For details on the contents of these separate directory trees, refer to
    <a href="directories.html">directories.html</a>.
    <strong>Note that the source directory and install directory should always be separate!</strong></p>

    <ol>
      <li>
        <P>Create the DSpace user.  This needs to be the same user that Tomcat (or Jetty etc) will run as.  e.g. as root run:</P>

        <PRE>useradd -m dspace</PRE>
      </li>

      <li>
        <P>Download the <A HREF="http://sourceforge.net/projects/dspace/">latest DSpace source code release</A> and unpack it:</P>

        <PRE>gunzip -c dspace-source-1.x.tar.gz | tar -xf -</PRE>

        </li>

      <li>
        <P><A NAME="pgdriver"></A>Copy the PostgreSQL JDBC driver (<code>.jar</code> file) into
<code><i>[dspace-source]</i>/lib</code>.  If you compiled PostgreSQL yourself, it'll be in <code>postgresql-7.x.x/src/interfaces/jdbc/jars/postgresql.jar</code>.  Alternatively you can download it directly from <A HREF="http://jdbc.postgresql.org/download.html">the PostgreSQL JDBC site</A>.  Make sure you get the driver for the version of PostgreSQL you're running and for JDBC2.</P>
      </li>

      <li>
        <P>Create a <code>dspace</code> database, owned by the <code>dspace</code> PostgreSQL user:</P>

        <PRE>createuser -U postgres -d -A -P dspace ; createdb -U dspace -E UNICODE dspace</PRE>

        <P>Enter a password for the DSpace database.  (This isn't the same as the <code>dspace</code> user's UNIX password.)</P>
      </li>

      <li>
        <P>Edit <code><i>[dspace-source]</i>/config/dspace.cfg</code>, in particular you'll need to set these properties:</P>

        <PRE>dspace.url
dspace.hostname
dspace.name
db.password   (the password you entered in the previous step)
mail.server
mail.from.address
feedback.recipient
mail.admin
alert.recipient (not essential but very useful!)</PRE>

        <P>Note that if you change <code>dspace.dir</code> you'll also need to change other properties with values that start with <code>/dspace</code>, e.g. <code>assetstore.dir</code>, <code>log.dir</code>...</P>
      </li>

      <li>
        <P>Create the directory for the DSpace installation.  As root, run:</P>

        <PRE>mkdir <i>[dspace]</i> ; chown dspace <i>[dspace]</i></PRE>

        <P>(Assuming the <code>dspace</code> UNIX username.)</P>
      </li>

      <li>
        <P>As the <code>dspace</code> UNIX user, compile and install DSpace:</P>

        <pre>cd <i>[dspace-source]</i> ; ant fresh_install</pre>

        <P>The most likely thing to go wrong here is the database connection.  See the <A HREF="#problems">common problems section</A>.</P>
      </li>

      <li>
        <P>Copy the DSpace Web application archives (<code>.war</code> files) to the appropriate directory in your Tomcat/Jetty/Resin installation.  For example:</P>

        <PRE>cp <i>[dspace-source]</i>/build/*.war <i>[tomcat]</i>/webapps</PRE>
      </li>

      <LI>
        <p>Create an initial administrator account:</p>

        <pre><i>[dspace]</i>/bin/create-administrator</pre>
      </LI>

      <LI>
        <P>Now the moment of truth!  Start up (or restart) Tomcat.  Visit the base URL of your server, e.g. http://dspace.myu.edu:8080/dspace.  You should see the DSpace home page.  Congratulations!</P>
      </LI>
    </ol>

    <p>In order to set up some communities and collections, you'll need to access the administration UI.  To do this, append 'admin' to your server's URL, e.g. http://dspace.myu.edu:8080/dspace/dspace-admin.</P>

    <H2><A NAME="advancedinstall">Advanced Installation</A></H2>

    <P>The above installation steps are sufficient to set up a test server to play around with, but there are a few other steps and options you should probably consider before deploying a DSpace production site.</P>

    <H3>'cron' Jobs</H3>

    <P>A couple of DSpace features require that a script is run regularly -- the e-mail subscription feature that alerts users of new items being deposited, and the new 'media filter' tool, that generates thumbnails of images and extracts the full-text of documents for indexing.</P>

    <P>To set these up, you just need to run the following command as the <code>dspace</code> UNIX user:</P>

    <PRE>crontab -e</PRE>

    <P>Then add the following lines:</P>

    <PRE># Send out subscription e-mails at 01:00 every day
0 1 * * * <i>[dspace]</i>/bin/sub-daily
# Run the media filter at 02:00 every day
0 2 * * * <i>[dspace]</i>/bin/filter-media</PRE>

    <P>Naturally you should change the frequencies to suit your environment.</P>

    <P>PostgreSQL also benefits from regular 'vacuuming', which optimizes the indices and clears out any deleted data.  Become the <code>postgres</code> UNIX user, run <code>crontab -e</code> and add (for example):

    <pre># Clean up the database nightly at 2.40am
40 2 * * * vacuumdb --analyze dspace > /dev/null 2>&1</pre>

    <p>In order that statistical reports are generated regularly and thus kept up to date you should set up the following cron jobs:</p>

    <pre># Run stat analyses
0 1 * * * [dspace]/bin/stat-general
0 1 * * * [dspace]/bin/stat-monthly
0 2 * * * [dspace]/bin/stat-report-general
0 2 * * * [dspace]/bin/stat-report-monthly</pre>

    <p>Obviously, you should choose execution times which are most useful to you, and you should ensure that the <code>-report-</code> scripts run a short while after the analysis scripts to give them time to complete (a run of around 8 months worth of logs can take around 25 seconds to complete); the resulting reports will let you know how long analysis took and you can adjust your cron times accordingly.</p>

    <P>For information on customising the output of this see <A HREF="configure.html#statistics">configuring system statistical reports</A>.</P>


    <H3>DSpace over HTTPS</H3>

    <P>Plain old HTTP is totally insecure, and if your DSpace uses username/password authentication or stores some restricted content, running it over HTTPS (HTTP over a Secure Socket Layer (SSL)) is advisable.  There are two options for this:  Using Apache HTTPD, or Tomcat/Jetty's in-built HTTPS support.</P>

    <P><strong>To use Apache HTTPD:</strong> The DSpace source bundle includes a partial Apache configuration <code>apache13.conf</code>, which contains most of the DSpace-specific configuration required.  It assumes you're using <A HREF="http://jakarta.apache.org/tomcat/tomcat-4.1-doc/config/webapp.html">mod_webapp</A>, which is deprecated and tricky to compile but a lot easier to configure than <code>mod_jk2</code> which is the current recommendation from Tomcat.   Use of this is optional, you might just want to use it as an example.  To use it directly, in the main Apache <code>httpd.conf</code>, you should:</P>

    <UL>
      <LI>Make sure <code>mod_ssl</code> and <code>mod_webapp</code> are configured and loaded</LI>
      <LI>Remove/comment out etc. any existing or default SSL virtual host</LI>
      <LI>Ensure Apache will run with the UNIX user and group DSpace will run as</LI>
      <LI>Include the DSpace part, e.g. with: <code>Include <i>[dspace]</i>/config/httpd.conf</code>.  You can decide where the DSpace part will go in your file system--see the <A HREF="configure.html#templates">configuration section</A>.</LI>
    </UL>

    <P><strong>To use Tomcat or Jetty's HTTPS support</strong> consult the documentation for the relevant tool.</P>


    <H3><A NAME="handles">The Handle Server</A></H3>

    <P>First a few facts to clear up some common misconceptions:</P>

    <UL>
      <LI><P>You don't <strong>have</strong> to use CNRI's Handle system.  At the moment, you need to change the code a little to use something else (e.g PURLs) but that should change soon.</P></LI>

      <LI><P>You'll notice that while you've been playing around with a test server, DSpace has apparently been creating handles for you looking like <code>hdl:123456789/24</code> and so forth.  These aren't really Handles, since the global Handle system doesn't actually know about them, and lots of other DSpace test installs will have created the same IDs.</P>

      <P>They're only really Handles once you've registered a prefix with CNRI (see below) and have correctly set up the Handle server included in the DSpace distribution.  This Handle server communicates with the rest of the global Handle infrastructure so that anyone that understands Handles can find the Handles your DSpace has created.</P>
      </LI>
    </UL>

    <P>If you want to use the Handle system, you'll need to set up a Handle server.  This is included with DSpace.  Note that this is not required in order to evaluate DSpace; you only need one if you are running a production service.  You'll need to obtain a Handle prefix from <A HREF="http://www.handle.net/">the central CNRI Handle site</A>.</P>

    <P>A Handle server runs as a separate process that receives TCP requests from other Handle servers, and issues resolution requests to a global server or servers if a Handle entered locally does not correspond to some local content.  The Handle protocol is based on TCP, so it will need to be installed on a server that can broadcast and receive TCP on port 2641.</P>

    <P>The Handle server code is included with the DSpace code in
<code><i>[dspace-source]</i>/lib/handle.jar</code>.  A script exists to create a simple Handle configuration - simply run <code><i>[dspace]</i>/bin/make-handle-config</code> after you've set the appropriate parameters in <code>dspace.cfg</code>.  You can also create a Handle configuration directly by following the <A HREF="http://www.handle.net/hs_manual_18jan02/server_manual_2.html">installation instructions on handle.net</A>, but with these changes:</P>

    <UL>
      <LI>Instead of running:
      <PRE>java -cp /hs/bin/handle.jar net.handle.server.SimpleSetup /hs/svr_1</pre>
      as directed in the <A HREF="http://hdl.handle.net/4263537/4093">Handle Server Administration Guide</A>, you should run
      <pre><i>[dspace]</i>/bin/dsrun net.handle.server.SimpleSetup <i>[dspace]</i>/handle-server</pre>
      ensuring that <code><i>[dspace]</i>/handle-server</code> matches whatever you have in <code>dspace.cfg</code> for the <code>handle.dir</code> property.</LI>

      <LI>Edit the resulting <code><i>[dspace]</i>/handle-server/config.dct</code> file to include the following lines in the <code>"server_config"</code> clause:

      <pre>"storage_type" = "CUSTOM"
"storage_class" = "org.dspace.handle.HandlePlugin"</pre>

      <P>This tells the Handle server to get information about individual Handles from the DSpace code.</P></LI>
    </UL>

    <P>Whichever approach you take, start the Handle server with <code><i>[dspace]</i>/bin/start-handle-server</code>, as the DSpace user.  Once the configuration file has been generated, you will need to go to <a href="http://hdl.handle.net/4263537/5014">http://hdl.handle.net/4263537/5014</a> to upload the generated sitebndl.zip file. The upload page will ask you for your contact information. An administrator will then create the naming authority/prefix on the root service (known as the Global Handle Registry), and notify you when this has been completed. You will not be able to continue the handle server installation until you receive further information concerning your naming authority.</P>

    <P>Note that since the DSpace code manages individual Handles, administrative operations such as Handle creation and modification aren't supported by DSpace's Handle server.</P>


    <H2><A NAME="checking">Checking Your Installation</A></H2>
    <p>TODO</p>

    <H2><A NAME="knownbugs">Known Bugs</A></H2>

    <P>In any software project of the scale of DSpace, there will be bugs.  Sometimes, a stable version of DSpace includes known bugs.  We do not always wait until every known bug is fixed before a release.  If the software is sufficiently stable and an improvement on the previous release, and the bugs are minor and have known workarounds, we release it to enable the community to take advantage of those improvements.</P>

    <P>The known bugs in a release are documented in the <code>KNOWN_BUGS</code> file in the source package.</P>

    <P>Please see the <A HREF="http://sourceforge.net/tracker/?atid=119984&amp;group_id=19984&amp;func=browse">DSpace bug tracker</A> for further information on current bugs, and to find out if the bug has subsequently been fixed.  This is also where you can report any further bugs you find.</P>


    <H2><A NAME="problems">Common Problems</A></H2>

    <P>In an ideal world everyone would follow the above steps and have a fully functioning DSpace.  Of couse, in the real world it doesn't always seem to work out that way.  This section lists common problems that people encounter when installing DSpace, and likely causes and fixes.  This is likely to grow over time as we learn about users' experiences.</P>

    <DL>
      <DT>Database errors occur when you run <code>ant fresh_install</code></DT>

      <DD>
        <P>There are two common errors that occur.  If your error looks like this--</P>

        <PRE>[java] 2004-03-25 15:17:07,730 INFO  org.dspace.storage.rdbms.InitializeDatabase @ Initializing Database
[java] 2004-03-25 15:17:08,816 FATAL org.dspace.storage.rdbms.InitializeDatabase @ Caught exception:
[java] org.postgresql.util.PSQLException: Connection refused. Check that the hostname and port are correct and that the postmaster is accepting TCP/IP connections.
[java]     at org.postgresql.jdbc1.AbstractJdbc1Connection.openConnection(AbstractJdbc1Connection.java:204)
[java]     at org.postgresql.Driver.connect(Driver.java:139)</PRE>

        <P>it usually means you haven't yet added the relevant configuration parameter to your PostgreSQL configuration <A HREF="#enabletcpip">(see above)</A>, or perhaps you haven't restarted PostgreSQL after making the change.
Also, make sure that the <code>db.username</code> and <code>db.password</code> properties are correctly set in
<code><i>[dspace-source]</i>/config/dspace.cfg</code>.</P>

        <P>An easy way to check that your DB is working OK over TCP/IP is to try this on the command line:</P>

        <PRE>psql -U dspace -W -h localhost</PRE>

        <P>Enter the <code>dspace</code> <em>database</em> password, and you should be dropped into the psql tool with a <code>dspace=&gt;</code> prompt.</P>

        <P>Another common error looks like this:</P>

        <PRE>[java] 2004-03-25 16:37:16,757 INFO  org.dspace.storage.rdbms.InitializeDatabase @ Initializing Database
[java] 2004-03-25 16:37:17,139 WARN  org.dspace.storage.rdbms.DatabaseManager @ Exception initializing DB pool
[java] java.lang.ClassNotFoundException: org.postgresql.Driver
[java]     at java.net.URLClassLoader$1.run(URLClassLoader.java:198)
[java]     at java.security.AccessController.doPrivileged(Native Method)
[java]     at java.net.URLClassLoader.findClass(URLClassLoader.java:186)</PRE>

        <P>This means that the PostgreSQL JDBC driver is not present in <code><i>[dspace-source]</i>/lib</code>.  <A HREF="#pgdriver">See above.</A></P>


      <DT>Tomcat doesn't shut down</DT>
      <DD><P>If you're trying to tweak Tomcat's configuration but nothing seems to make a difference to the error you're seeing, you might find that Tomcat hasn't been shutting down properly, perhaps because it's waiting for a stale connection to close gracefully which won't happen.  To see if this is the case, try:</P>

      <PRE>ps -ef | grep java</PRE>

      <P>and look for Tomcat's Java processes.  If they stay arround after running Tomcat's <code>shutdown.sh</code> script, trying <code>kill</code>ing them (with <code>-9</code> if necessary), then starting Tomcat again.</P></DD>

      <DT>Database connections don't work, or accessing DSpace takes forever</DT>
      <DD><P>If you find that when you try to access a DSpace Web page and your browser sits there connecting, or if the database connections fail, you might find that a 'zombie' database connection is hanging around preventing normal operation.  To see if this is the case, try:</P>

      <PRE>ps -ef | grep postgres</PRE>

      <P>You might see some processes like this</P>

      <PRE>dspace 16325  1997  0  Feb 14  ?         0:00 postgres: dspace dspace 127.0.0.1 idle in transaction</PRE>

      <P>This is normal--DSpace maintains a 'pool' of open database connections, which are re-used to avoid the overhead of constantly opening and closing connections.  If they're 'idle' it's OK; they're waiting to be used.  However sometimes, if something went wrong, they might be stuck in the middle of a query, which seems to prevent other connections from operating, e.g.:</P>

      <PRE>dspace 16325  1997  0  Feb 14  ?         0:00 postgres: dspace dspace 127.0.0.1 SELECT</PRE>

      <P>This means the connection is in the middle of a <CODE>SELECT</CODE> operation, and if you're not using DSpace right that instant, it's probably a 'zombie' connection.  If this is the case, try <code>kill</code>ing the process, and stopping and restarting Tomcat.</P></DD>

      <dt>You've made changes to the code or to the JSP's and rebuilt DSpace successfully, but when you run Tomcat
      you don't see any of your changes in DSpace.</dt>

      <dd><p>After you've rebuilt DSpace and copied <code>dspace.war</code> from your <code><i>[dspace-source]</i>/build</code> directory
    into your <code><i>[tomcat]</i>/webapps</code> directory, you must
      also <strong>delete</strong> the existing <code><i>[tomcat]</i>/webapps/dspace</code> directory <strong>before</strong> re-starting Tomcat. Otherwise
      Tomcat will continue to use the old code.<p></dd>

    </DL>

    <HR>

    <ADDRESS>
      Copyright &copy; 2002-2005 MIT and Hewlett Packard
    </ADDRESS>
  </BODY>
</HTML>
