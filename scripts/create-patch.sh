#!/bin/bash

# Create patches for the file list generated by scripts/list-overlay-file.sh
#
# This assumes that you are currently in the upgrade branch and you have completed merging the dspace upgrades to the base modules.
#
# The patch is generated by comparing the base module files in the list from current branch (upgraded version) to the drum-main which is still in previous version of dspace.
# The file paths in the patch are then changed from the base module paths to their corresponding overlay file paths to make the patch applicable to the overlay modules.
#
# The generated patches can be applied to the overlay modules using the script/apply-patch.sh
#
# Note: There will be "unknown revision" messages for files missing in the base module. This could be due to the file was a UMD introduced custom file or it could be that it was deleted in the upgrade. If it is latter case, make sure to delete the file in the overlay module while retaining the functionality customization that the file was providing.
#

DRUM_SOURCE_DIR=/apps/git/drum

# Get the current branch
upgradeBranch=`git name-rev --name-only HEAD`

# Go to root
cd $DRUM_SOURCE_DIR

if [ ! -d scripts/patches ] ; then
  mkdir scripts/patches
fi

for listFile in `ls scripts/work/*.list`
do
  echo Processing $listFile
  listName=`echo $listFile | rev | cut -d"/" -f1 | rev`
  for file in `cat $listFile`
  do
    git diff drum-main..$upgradeBranch $file >> scripts/patches/$listName
  done

  sed -i .patch 's/\/dspace-api\//\/dspace\/modules\/additions\//g' scripts/patches/$listName

  module=`echo $listName | cut -d"." -f1`
  if [ "$listName" != "additions.list" ]  ; then
    sed "s/\/dspace-$module\//\/dspace\/modules\/$module\//g" < scripts/patches/$listName | cat > scripts/patches/$listName.patch
  fi
  if [ "$listName" = "xmlui-mirage2.list" ] ; then
    sed 's/main\/webapp\//main\/webapp\/themes\/Mirage2\//g' < scripts/patches/$listName.patch | cat > scripts/patches/$listName.patch.new
    mv scripts/patches/$listName.patch.new scripts/patches/$listName.patch
  fi

  rm scripts/patches/$listName

done
