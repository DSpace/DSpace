function DSpaceSetupAutocomplete(e,t){null==t.authorityName&&(t.authorityName=dspace_makeFieldInput(t.inputName,"_authority"));var a=jQuery("#"+e+" input[name='"+t.authorityName+"']"),n=jQuery("#"+e+" input[name='"+t.inputName+"']");n.parent("td").attr("style","white-space:nowrap;");var l=t.contextPath+"/choices/"+t.metadataField,o=null==t.collection?-1:t.collection;null!=a&&n.data("previousData",{authority:a.val(),value:n.val()});var r={lenght:2,search:function(e,a){jQuery("#"+t.indicatorID).show()},source:function(e,a){jQuery.ajax({url:l,dataType:"xml",data:{query:e.term,collection:o,format:"ul"},success:function(e){jQuery("#"+t.indicatorID).hide(),a(jQuery("li",e).map(function(){return{authority:jQuery(this).attr("authority"),label:jQuery("span.label",this).text(),value:jQuery("span.value",this).text()}}))}})},select:function(l,o){n.data("previousData",o.item);var r=o.item.authority,i=r;if(null!=a&&(a.val(i),null!=t.confidenceName)){var u=jQuery("#"+e+" input[name='"+t.confidenceName+"']");null!=u&&(""!=r?u.val("accepted"):u.val(""))}DSpaceUpdateConfidence(document,t.confidenceIndicatorID,null==i||""==i?"blank":"accepted")}};n.autocomplete(r).change(function(){var e=n.data("previousData"),l="",o=n.val();null!=a&&(l=a.val()),l==e.authority&&o==e.value||null!=a&&(a.val(" "),DSpaceUpdateConfidence(document,t.confidenceIndicatorID,"blank"))})}function DSpaceChoiceLookup(e,t,a,n,l,o,r,i,u){e+="?field="+t+"&formID="+a+"&valueInput="+n+"&authorityInput="+l+"&collection="+r+"&isName="+i+"&isRepeating="+u+"&confIndicatorID="+o;var s=i?dspace_makeFieldInput(n,"_last"):n,c=document.getElementById(a).elements[s],m=0;null!=c&&(m=$(c).cumulativeOffset());var d,p;null==window.screenX?(d=window.screenLeft+m.left-300,p=window.screenTop+m.top-235):(d=window.screenX+m.left-300,p=window.screenY+m.top-235),d<0&&(d=0),p<0&&(p=0);var v=window.open(e,"ignoreme","width=600,height=470,left="+d+",top="+p+",toolbar=no,menubar=no,location=no,status=no,resizable");return window.focus&&v.focus(),!1}function DSpaceChoicesSetup(e){var t=document.getElementById("aspect_general_ChoiceLookupTransformer_list_choicesList");for(i=0;i<t.childNodes.length;++i)if("LEGEND"==t.childNodes[i].nodeName){e.statline=t.childNodes[i],e.statline_template=t.childNodes[i].innerHTML,t.childNodes[i].innerHTML="Loading...";break}DSpaceChoicesLoad(e)}function DSpaceChoicesLoad(e){var t=e.elements.paramField.value,a=e.elements.paramValue.value,n=e.elements.paramStart.value,l=e.elements.paramLimit.value,o=e.elements.paramFormID.value,r=e.elements.paramCollection.value,i="true"==e.elements.paramIsName.value,u="true"==e.elements.paramIsRepeating.value,s="true"==e.elements.paramIsClosed.value,c=e.elements.contextPath.value,m=e.elements.paramFail.value,d=e.elements.paramValueInput.value,p="";if(null!=e.elements.paramNonAuthority&&(p=e.elements.paramNonAuthority.value),0==a.length){var v=window.opener.document.getElementById(o);a=i?makePersonName(v.elements[dspace_makeFieldInput(d,"_last")].value,v.elements[dspace_makeFieldInput(d,"_first")].value):v.elements[d].value,u&&(i?(v.elements[dspace_makeFieldInput(d,"_last")].value=null,v.elements[dspace_makeFieldInput(d,"_first")].value=null):v.elements[d].value=null)}var f=document.getElementById("lookup_indicator_id");null!=f&&(f.style.display="inline"),new Ajax.Request(c+"/choices/"+t,{method:"get",parameters:{query:a,format:"select",collection:r,start:n,limit:l},onException:function(e,t){window.alert(m+" Exception="+t),null!=f&&(f.style.display="none")},onFailure:function(){window.alert(m+" HTTP error resonse"),null!=f&&(f.style.display="none")},onSuccess:function(t){var n=t.responseXML.documentElement,l=n.getAttributeNode("error");null!=l&&"true"==l.value&&window.alert(m+" Server indicates error in response.");var o=n.getElementsByTagName("option"),r=1*n.getAttributeNode("start").value,u=r+o.length,c=n.getAttributeNode("total").value,d=n.getAttributeNode("more");e.elements.more.disabled=!(null!=d&&"true"==d.value),e.elements.paramStart.value=u;for(var v=e.elements.chooser,h=v.length-1;h>=0;--h)v.remove(h);var g=-1,y=-1;for(h=0;h<o.length;++h){for(var I=o.item(h),_="",N=0;N<I.childNodes.length;++N){var w=I.childNodes[N];"#text"==w.nodeName&&(_+=w.data)}var k=I.getAttributeNode("value").value,D=new Option(_,k);D.authority=I.getAttributeNode("authority").value,v.add(D,null),a==k&&(g=v.options.length-1),null!=I.getAttributeNode("selected")&&(y=v.options.length-1)}s||v.add(new Option(dspace_formatMessage(p,a),a),null);var b=-1;if(y>=0?b=y:g>=0?b=g:1==v.options.length&&(b=0),b>=0){v.options[b].defaultSelected=!0;var x=v.options[b];i?(e.elements.text1.value=lastNameOf(x.value),e.elements.text2.value=firstNameOf(x.value)):e.elements.text1.value=x.value}null!=f&&(f.style.display="none");var C=u+(s?2:1);e.statline.innerHTML=dspace_formatMessage(e.statline_template,r+1,C,Math.max(c,C),a)}})}function DSpaceChoicesSelectOnChange(){var e=document.getElementById("aspect_general_ChoiceLookupTransformer_div_lookup"),t=e.elements.chooser,a=t.options[t.selectedIndex];"true"==e.elements.paramIsName.value?(e.elements.text1.value=lastNameOf(a.value),e.elements.text2.value=firstNameOf(a.value)):e.elements.text1.value=a.value}function DSpaceChoicesAcceptOnClick(){var e=this.form.elements.chooser,t="true"==this.form.elements.paramIsName.value,a="true"==this.form.elements.paramIsRepeating.value,n=this.form.elements.paramValueInput.value,l=this.form.elements.paramAuthorityInput.value,o=this.form.elements.paramFormID.value,r=null==this.form.elements.paramConfIndicatorID?null:this.form.elements.paramConfIndicatorID.value;if(0==l.length&&(l=dspace_makeFieldInput(n,"_authority")),n.length>0){var i=window.opener.document.getElementById(o);if(t?(i.elements[dspace_makeFieldInput(n,"_last")].value=this.form.elements.text1.value,i.elements[dspace_makeFieldInput(n,"_first")].value=this.form.elements.text2.value):i.elements[n].value=this.form.elements.text1.value,l.length>0&&null!=i.elements[l]){var u="",s=l.lastIndexOf("_authority_");u=s<0?l.substring(0,l.length-10)+"_confidence":l.substring(0,s)+"_confidence_"+l.substring(s+11);var c=null;e.selectedIndex>=0&&null!=e.options[e.selectedIndex].authority&&(c=e.options[e.selectedIndex].authority,i.elements[l].value=c),null!=i.elements[u]&&(i.elements[u].value="accepted"),DSpaceUpdateConfidence(window.opener.document,r,null==c||""==c?"blank":"accepted")}if(a){var m=i.elements["submit_"+n+"_add"];null!=m?m.click():alert('Sanity check: Cannot find button named "submit_'+n+'_add"')}}return window.close(),!1}function DSpaceChoicesMoreOnClick(){DSpaceChoicesLoad(this.form)}function DSpaceChoicesCancelOnClick(){return window.close(),!1}function makePersonName(e,t){return null==t||0==t.length?e:e+", "+t}function firstNameOf(e){var t=e.indexOf(",");return t<0?"":stringTrim(e.substring(t+1))}function lastNameOf(e){var t=e.indexOf(",");return stringTrim(t<0?e:e.substring(0,t))}function stringTrim(e){for(var t=0,a=e.length;" "==e.charAt(t)&&t<a;++t);for(;a>t&&" "==e.charAt(a-1);--a);return e.slice(t,a)}function dspace_formatMessage(){var e,t=dspace_formatMessage.arguments[0];for(e=1;e<arguments.length;++e){var a="@"+e+"@";t.search(a)>=0&&(t=t.replace(a,dspace_formatMessage.arguments[e]))}return t}function dspace_makeFieldInput(e,t){var a=e.search("_[0-9]+$");return a<0?e+t:e.substr(0,a)+t+e.substr(a)}function DSpaceUpdateConfidence(e,t,a){if(null!=t&&""!=t){var n=e.getElementById(t);if(null!=n)if(null==n.className)n.className="cf-"+a;else{for(var l=n.className.split(" "),o="",r=!1,i=0;i<l.length;++i)l[i].match("^cf-[a-zA-Z0-9]+$")?(o+="cf-"+a+" ",r=!0):o+=l[i]+" ";r||(o+="cf-"+a+" "),n.className=o}}}function DSpaceAuthorityOnChange(e,t,a){if(null!=t&&""!=t){var n=document.getElementById(t);null!=n&&(n.value="accepted")}return DSpaceUpdateConfidence(document,a,"accepted"),!1}function DSpaceToggleAuthorityLock(e,t){if(null==t||""==t)return!1;var a=document.getElementById(t);if(null==a)return!1;for(var n=e.className.split(" "),l="",o=!1,r=!1,i=0;i<n.length;++i)"is-locked"==n[i]?(o=!1,r=!0):"is-unlocked"==n[i]?(o=!0,r=!0):l+=n[i]+" ";return!!r&&(e.className=l+(o?"is-locked":"is-unlocked")+" ",a.readOnly=o,!1)}